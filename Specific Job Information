--- To find the User information on the specific Job
SELECT 
    s.session_id AS SPID,
    s.login_name,
    s.host_name AS ServerName,
    DB_NAME(r.database_id) AS DatabaseName,
    j.name AS JobName,
    r.command,
    r.start_time,
    r.status,
    r.cpu_time,
    r.total_elapsed_time,
    r.logical_reads + r.reads AS DiskIO
FROM msdb.dbo.sysjobs j
JOIN msdb.dbo.sysjobactivity ja ON j.job_id = ja.job_id
JOIN sys.dm_exec_sessions s ON ja.session_id = s.session_id
JOIN sys.dm_exec_requests r ON s.session_id = r.session_id
WHERE s.program_name LIKE 'SQLAgent%';

--- Enhanced SQL Monitoring Query for SQL Agent Jobs
SELECT 
    j.name AS JobName,
    ja.start_execution_date AS JobStartTime,
    ja.stop_execution_date AS JobEndTime,
    s.session_id AS SPID,
    s.login_name AS LoginName,
    s.host_name AS ServerName,
    DB_NAME(r.database_id) AS DatabaseName,
    r.command AS CommandType,
    st.text AS CommandText,
    r.status AS RequestStatus,
    r.cpu_time AS CPUTime_ms,
    r.total_elapsed_time AS ElapsedTime_ms,
    r.logical_reads AS LogicalReads,
    r.reads AS PhysicalReads,
    r.writes AS Writes,
    r.row_count AS RowsReturned,
    r.blocking_session_id AS BlockingSPID,
    r.wait_type,
    r.wait_time AS WaitTime_ms,
    r.scheduler_id,
    r.plan_handle,
    r.query_hash,
    r.query_plan_hash
FROM msdb.dbo.sysjobs j
JOIN msdb.dbo.sysjobactivity ja ON j.job_id = ja.job_id
JOIN sys.dm_exec_sessions s ON ja.session_id = s.session_id
JOIN sys.dm_exec_requests r ON s.session_id = r.session_id
CROSS APPLY sys.dm_exec_sql_text(r.sql_handle) AS st
WHERE s.program_name LIKE 'SQLAgent%'
  AND ja.start_execution_date IS NOT NULL;

